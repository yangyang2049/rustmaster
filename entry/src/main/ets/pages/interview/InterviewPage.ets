import { InterviewItem, Language } from '../../data/RustTypes';
import { LanguageDataManager } from '../../utils/LanguageDataManager';
import { Spacing, Sizes, FontSizes, FontWeights, Colors, SystemColors } from '../../utils/DesignSystem';
import { InterviewQuestionsManager } from '../../utils/InterviewQuestionsManager';
import { ToastUtil } from '../../utils/ToastUtil';
import common from '@ohos.app.ability.common';

// æ¨¡æ‹Ÿé¢è¯•çŠ¶æ€
enum MockState {
  SETUP,      // è®¾ç½®é˜¶æ®µ
  RUNNING,    // ç­”é¢˜ä¸­
  TIMEOUT,    // æ—¶é—´åˆ°
  RATING,     // è‡ªæˆ‘è¯„ä»·
  REVIEW      // æŸ¥çœ‹è¦ç‚¹
}

// è®¡æ—¶å™¨é¢„è®¾
interface TimerPreset {
  label: string;
  seconds: number;
  icon: string;
}

@Component
export struct InterviewPage {
  @Prop language: Language = Language.RUST;
  // ä¸»æ ‡ç­¾é¡µ
  @State activeTab: number = 0; // 0: é¢˜åº“, 1: æ¨¡æ‹Ÿé¢è¯•

  // é¢˜åº“çŠ¶æ€
  @State expandedInterview: string | null = null;
  @State filterDifficulty: string | null = null;
  @State allQuestions: InterviewItem[] = []; // åˆå¹¶åçš„æ‰€æœ‰é—®é¢˜ï¼ˆå†…ç½®+è‡ªå®šä¹‰ï¼‰
  @Prop showAddDialog: boolean = false; // æ˜¾ç¤ºæ·»åŠ é—®é¢˜å¯¹è¯æ¡†ï¼ˆä»å¤–éƒ¨æ§åˆ¶ï¼‰
  onChangeShowAddDialog?: (show: boolean) => void; // å›è°ƒå‡½æ•°ï¼Œç”¨äºé€šçŸ¥å¤–éƒ¨çŠ¶æ€å˜åŒ–
  @State preventToggle: boolean = false; // é˜²æ­¢åˆ‡æ¢å±•å¼€çŠ¶æ€
  @State isSavingQuestion: boolean = false; // é˜²æ­¢é‡å¤æäº¤

  // æ·»åŠ é—®é¢˜è¡¨å•çŠ¶æ€
  @State newQuestionText: string = '';
  @State newAnswerText: string = '';
  @State newDifficulty: string = 'ç®€å•';
  @State newTagsText: string = '';

  // æ¨¡æ‹Ÿé¢è¯•çŠ¶æ€
  @State mockState: MockState = MockState.SETUP;
  @State selectedPresetIndex: number = 1; // é»˜è®¤ 1 åˆ†é’Ÿ
  @State currentQuestionIndex: number = 0;
  @State remainingSeconds: number = 60;
  @State timerInterval: number = -1;
  @State selfRating: number = -1; // -1: æœªè¯„ä»·, 0: è‡ªä¿¡, 1: ä¸€èˆ¬, 2: æ…Œäº†

  private context: common.UIAbilityContext = getContext(this) as common.UIAbilityContext;

  private timerPresets: TimerPreset[] = [
    { label: '30ç§’', seconds: 30, icon: '' },
    { label: '1åˆ†é’Ÿ', seconds: 60, icon: '' },
    { label: '2åˆ†é’Ÿ', seconds: 120, icon: '' },
    { label: '5åˆ†é’Ÿ', seconds: 300, icon: '' }
  ];

  async aboutToAppear(): Promise<void> {
    await this.loadAllQuestions();
  }

  private async loadAllQuestions(): Promise<void> {
    try {
      const customQuestions = await InterviewQuestionsManager.getCustomQuestions();
      const builtinQuestions = LanguageDataManager.getInterviewQuestions(this.language);
      this.allQuestions = builtinQuestions.concat(customQuestions);
    } catch (err) {
      console.error(`Failed to load custom questions: ${JSON.stringify(err)}`);
      this.allQuestions = LanguageDataManager.getInterviewQuestions(this.language);
    }
  }

  private toggleInterview(id: string): void {
    this.expandedInterview = this.expandedInterview === id ? null : id;
  }

  private getDifficultyColor(difficulty: string): ResourceColor {
    switch (difficulty) {
      case 'ç®€å•':
        return $r(Colors.SUCCESS);
      case 'ä¸­ç­‰':
        return $r(Colors.WARNING);
      case 'å›°éš¾':
        return $r(Colors.ERROR);
      default:
        return $r(Colors.TEXT_TERTIARY);
    }
  }

  private getDifficultyBgColor(difficulty: string): ResourceColor {
    switch (difficulty) {
      case 'ç®€å•':
        return $r(Colors.SUCCESS_BG);
      case 'ä¸­ç­‰':
        return $r(Colors.WARNING_BG);
      case 'å›°éš¾':
        return $r(Colors.ERROR_BG);
      default:
        return $r(Colors.BG_SECONDARY);
    }
  }

  private getFilteredQuestions(): InterviewItem[] {
    if (this.filterDifficulty === null) {
      return this.allQuestions;
    }
    return this.allQuestions.filter(q => q.difficulty === this.filterDifficulty);
  }

  private getCurrentMockQuestion(): InterviewItem | null {
    if (this.currentQuestionIndex >= 0 && this.currentQuestionIndex < this.allQuestions.length) {
      return this.allQuestions[this.currentQuestionIndex];
    }
    return null;
  }

  private formatTime(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  }

  private getTimerColor(): ResourceColor {
    if (this.remainingSeconds <= 10) {
      return $r(Colors.ERROR);
    } else if (this.remainingSeconds <= 30) {
      return $r(Colors.WARNING);
    }
    return $r(Colors.TEXT_PRIMARY);
  }

  private startMockInterview(): void {
    if (this.allQuestions.length === 0) {
      ToastUtil.showToast(this.context, 'è¯·å…ˆæ·»åŠ é¢è¯•é—®é¢˜');
      return;
    }
    this.stopTimer();
    const preset = this.timerPresets[this.selectedPresetIndex] ?? this.timerPresets[0];
    this.remainingSeconds = preset.seconds;
    this.mockState = MockState.RUNNING;
    this.selfRating = -1;

    // éšæœºé€‰æ‹©ä¸€ä¸ªé—®é¢˜
    this.currentQuestionIndex = Math.floor(Math.random() * this.allQuestions.length);

    // å¼€å§‹è®¡æ—¶
    this.timerInterval = setInterval(() => {
      if (this.remainingSeconds > 0) {
        this.remainingSeconds--;
      } else {
        this.stopTimer();
        this.mockState = MockState.TIMEOUT;
      }
    }, 1000);
  }

  private stopTimer(): void {
    if (this.timerInterval !== -1) {
      clearInterval(this.timerInterval);
      this.timerInterval = -1;
    }
  }

  private skipQuestion(): void {
    if (this.allQuestions.length === 0) {
      ToastUtil.showToast(this.context, 'æš‚æ— å¯ç”¨é¢è¯•é¢˜');
      return;
    }
    this.stopTimer();
    this.currentQuestionIndex = Math.floor(Math.random() * this.allQuestions.length);
    const preset = this.timerPresets[this.selectedPresetIndex] ?? this.timerPresets[0];
    this.remainingSeconds = preset.seconds;
    this.timerInterval = setInterval(() => {
      if (this.remainingSeconds > 0) {
        this.remainingSeconds--;
      } else {
        this.stopTimer();
        this.mockState = MockState.TIMEOUT;
      }
    }, 1000);
  }

  private submitRating(rating: number): void {
    this.selfRating = rating;
    this.mockState = MockState.REVIEW;
  }

  private nextQuestion(): void {
    this.startMockInterview();
  }

  private exitMock(): void {
    this.stopTimer();
    this.mockState = MockState.SETUP;
  }

  aboutToDisappear(): void {
    this.stopTimer();
  }

  private async handleAddQuestion(): Promise<void> {
    if (this.isSavingQuestion) {
      return;
    }
    if (!this.newQuestionText.trim() || !this.newAnswerText.trim()) {
      ToastUtil.showToast(this.context, 'è¯·å¡«å†™é—®é¢˜å’Œç­”æ¡ˆ');
      return;
    }

    const tags = this.newTagsText.trim()
      ? this.newTagsText.split(/[,ï¼Œ]/).map(t => t.trim()).filter(t => t.length > 0)
      : [];

    const newQuestion: InterviewItem = {
      id: InterviewQuestionsManager.generateQuestionId(),
      question: this.newQuestionText.trim(),
      answer: this.newAnswerText.trim(),
      difficulty: this.newDifficulty as 'ç®€å•' | 'ä¸­ç­‰' | 'å›°éš¾',
      tags: tags
    };

    this.isSavingQuestion = true;
    try {
      const success = await InterviewQuestionsManager.addCustomQuestion(newQuestion);
      if (success) {
        ToastUtil.showToast(this.context, 'é—®é¢˜æ·»åŠ æˆåŠŸ');
        if (this.onChangeShowAddDialog) {
          this.onChangeShowAddDialog(false);
        }
        this.resetAddForm();
        await this.loadAllQuestions();
      } else {
        ToastUtil.showToast(this.context, 'æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    } finally {
      this.isSavingQuestion = false;
    }
  }

  private resetAddForm(): void {
    this.newQuestionText = '';
    this.newAnswerText = '';
    this.newDifficulty = 'ç®€å•';
    this.newTagsText = '';
  }

  private async handleDeleteQuestion(questionId: string): Promise<void> {
    // åªå…è®¸åˆ é™¤è‡ªå®šä¹‰é—®é¢˜
    if (!questionId.startsWith('custom_')) {
      ToastUtil.showToast(this.context, 'æ— æ³•åˆ é™¤å†…ç½®é—®é¢˜');
      return;
    }

    const success = await InterviewQuestionsManager.deleteCustomQuestion(questionId);
    if (success) {
      ToastUtil.showToast(this.context, 'é—®é¢˜å·²åˆ é™¤');
      await this.loadAllQuestions();
      if (this.expandedInterview === questionId) {
        this.expandedInterview = null;
      }
    } else {
      ToastUtil.showToast(this.context, 'åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // ========== é¡¶éƒ¨æ ‡ç­¾æ  (ç³»ç»Ÿ Chip é£æ ¼) ==========
  @Builder
  TabBar() {
    Row() {
      Text('é¢˜åº“')
        .fontSize(FontSizes.SMALL)
        .fontWeight(this.activeTab === 0 ? FontWeights.MEDIUM : FontWeights.NORMAL)
        .fontColor(this.activeTab === 0 ? $r(Colors.TEXT_PRIMARY) : $r(Colors.TEXT_TERTIARY))
        .layoutWeight(1)
        .height(Sizes.TAB_HEIGHT)
        .textAlign(TextAlign.Center)
        .backgroundColor(this.activeTab === 0 ? $r(Colors.BG_CARD) : SystemColors.TRANSPARENT)
        .borderRadius(Sizes.RADIUS_XL)
        .onClick(() => {
          if (this.activeTab === 1) {
            this.exitMock();
          }
          this.activeTab = 0;
        })

      Text('æ¨¡æ‹Ÿé¢è¯•')
        .fontSize(FontSizes.SMALL)
        .fontWeight(this.activeTab === 1 ? FontWeights.MEDIUM : FontWeights.NORMAL)
        .fontColor(this.activeTab === 1 ? $r(Colors.TEXT_PRIMARY) : $r(Colors.TEXT_TERTIARY))
        .layoutWeight(1)
        .height(Sizes.TAB_HEIGHT)
        .textAlign(TextAlign.Center)
        .backgroundColor(this.activeTab === 1 ? $r(Colors.BG_CARD) : SystemColors.TRANSPARENT)
        .borderRadius(Sizes.RADIUS_XL)
        .onClick(() => {
          this.activeTab = 1;
        })
    }
    .width('100%')
    .height(Sizes.TAB_BAR_HEIGHT)
    .padding(Sizes.TAB_BAR_PADDING)
    .backgroundColor($r(Colors.BG_SECONDARY))
    .borderRadius(Sizes.TAB_BAR_RADIUS)
    .margin({ bottom: Spacing.ELEMENT_SPACING_MD })
  }

  // ========== é¢˜åº“æ ‡ç­¾é¡µ ==========
  @Builder
  FilterChips() {
    Row() {
      Text('å…¨éƒ¨')
        .fontSize(FontSizes.SMALL)
        .fontWeight(FontWeights.MEDIUM)
        .fontColor(this.filterDifficulty === null ? $r(Colors.TEXT_WHITE) : $r(Colors.TEXT_SECONDARY))
        .backgroundColor(this.filterDifficulty === null ? $r(Colors.RUST_PRIMARY) : $r(Colors.BG_SECONDARY))
        .padding({ left: 16, right: 16 })
        .height(Sizes.CHIP_HEIGHT)
        .borderRadius(Sizes.RADIUS_XL)
        .onClick(() => {
          this.filterDifficulty = null;
        })

      Text('ç®€å•')
        .fontSize(FontSizes.SMALL)
        .fontWeight(FontWeights.MEDIUM)
        .fontColor(this.filterDifficulty === 'ç®€å•' ? $r(Colors.TEXT_WHITE) : $r(Colors.TEXT_SECONDARY))
        .backgroundColor(this.filterDifficulty === 'ç®€å•' ? $r(Colors.SUCCESS) : $r(Colors.BG_SECONDARY))
        .padding({ left: 16, right: 16 })
        .height(Sizes.CHIP_HEIGHT)
        .borderRadius(Sizes.RADIUS_XL)
        .margin({ left: 12 })
        .onClick(() => {
          this.filterDifficulty = 'ç®€å•';
        })

      Text('ä¸­ç­‰')
        .fontSize(FontSizes.SMALL)
        .fontWeight(FontWeights.MEDIUM)
        .fontColor(this.filterDifficulty === 'ä¸­ç­‰' ? $r(Colors.TEXT_WHITE) : $r(Colors.TEXT_SECONDARY))
        .backgroundColor(this.filterDifficulty === 'ä¸­ç­‰' ? $r(Colors.WARNING) : $r(Colors.BG_SECONDARY))
        .padding({ left: 16, right: 16 })
        .height(Sizes.CHIP_HEIGHT)
        .borderRadius(Sizes.RADIUS_XL)
        .margin({ left: 12 })
        .onClick(() => {
          this.filterDifficulty = 'ä¸­ç­‰';
        })

      Text('å›°éš¾')
        .fontSize(FontSizes.SMALL)
        .fontWeight(FontWeights.MEDIUM)
        .fontColor(this.filterDifficulty === 'å›°éš¾' ? $r(Colors.TEXT_WHITE) : $r(Colors.TEXT_SECONDARY))
        .backgroundColor(this.filterDifficulty === 'å›°éš¾' ? $r(Colors.ERROR) : $r(Colors.BG_SECONDARY))
        .padding({ left: 16, right: 16 })
        .height(Sizes.CHIP_HEIGHT)
        .borderRadius(Sizes.RADIUS_XL)
        .margin({ left: 12 })
        .onClick(() => {
          this.filterDifficulty = 'å›°éš¾';
        })
    }
    .width('100%')
    .margin({ bottom: Spacing.ELEMENT_SPACING_MD })
  }

  @Builder
  DifficultyBadge(difficulty: string) {
    Text(difficulty)
      .fontSize(FontSizes.TINY)
      .fontWeight(FontWeights.MEDIUM)
      .fontColor(this.getDifficultyColor(difficulty))
      .backgroundColor(this.getDifficultyBgColor(difficulty))
      .padding({
        left: Spacing.ELEMENT_SPACING_SM,
        right: Spacing.ELEMENT_SPACING_SM,
        top: Spacing.ELEMENT_SPACING_XS,
        bottom: Spacing.ELEMENT_SPACING_XS
      })
      .borderRadius(Sizes.RADIUS_SM)
  }

  @Builder
  InterviewItemCard(item: InterviewItem) {
    Column() {
      Row() {
        Column() {
          Row() {
            Row() {
              this.DifficultyBadge(item.difficulty)
            }
            Blank()
            if (item.id.startsWith('custom_')) {
              Text('åˆ é™¤')
                .fontSize(FontSizes.TINY)
                .fontColor($r(Colors.ERROR))
                .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                .backgroundColor($r(Colors.ERROR_BG))
                .borderRadius(Sizes.RADIUS_SM)
                .margin({ right: 8 })
                .onClick(async () => {
                  this.preventToggle = true;
                  await this.handleDeleteQuestion(item.id);
                  setTimeout(() => {
                    this.preventToggle = false;
                  }, 100);
                })
            }
            Text(this.expandedInterview === item.id ? 'â–²' : 'â–¼')
              .fontSize(FontSizes.TINY)
              .fontColor($r(Colors.TEXT_TERTIARY))
          }
          .width('100%')
          .margin({ bottom: Spacing.ELEMENT_SPACING_SM })

          Text(item.question)
            .fontSize(FontSizes.BODY)
            .fontWeight(FontWeights.MEDIUM)
            .fontColor(this.expandedInterview === item.id ? $r(Colors.RUST_PRIMARY) : $r(Colors.TEXT_PRIMARY))
            .lineHeight(22)
            .margin({ bottom: Spacing.ELEMENT_SPACING_SM })

          Flex({ wrap: FlexWrap.Wrap }) {
            ForEach(item.tags, (tag: string, index: number) => {
              Text(tag)
                .fontSize(FontSizes.TINY)
                .fontColor($r(Colors.TEXT_TERTIARY))
                .backgroundColor($r(Colors.BG_SECONDARY))
                .padding({
                  left: Spacing.ELEMENT_SPACING_SM,
                  right: Spacing.ELEMENT_SPACING_SM,
                  top: Spacing.ELEMENT_SPACING_XS,
                  bottom: Spacing.ELEMENT_SPACING_XS
                })
                .borderRadius(Sizes.RADIUS_SM)
                .margin({ right: Spacing.ELEMENT_SPACING_XS, bottom: Spacing.ELEMENT_SPACING_XS })
            }, (tag: string, index: number) => `${tag}-${index}`)
          }
          .width('100%')
        }
        .layoutWeight(1)
        .alignItems(HorizontalAlign.Start)
      }
      .width('100%')
      .padding(Spacing.CARD_PADDING)
      .onClick(() => {
        if (!this.preventToggle) {
          this.toggleInterview(item.id);
        }
      })

      if (this.expandedInterview === item.id) {
        Column() {
          Divider()
            .color($r(Colors.BG_SECONDARY))
            .margin({ bottom: Spacing.ELEMENT_SPACING_MD })

          Text(item.answer)
            .fontSize(FontSizes.SMALL)
            .fontColor($r(Colors.TEXT_SECONDARY))
            .lineHeight(24)
            .width('100%')
        }
        .width('100%')
        .padding({
          left: Spacing.CARD_PADDING,
          right: Spacing.CARD_PADDING,
          bottom: Spacing.CARD_PADDING
        })
        .alignItems(HorizontalAlign.Start)
      }
    }
    .width('100%')
    .backgroundColor($r(Colors.BG_CARD))
    .borderRadius(Sizes.RADIUS_XL)
  }

  @Builder
  StatsRow() {
    Row() {
      Text(`å…± ${this.getFilteredQuestions().length} é¢˜`)
        .fontSize(FontSizes.TINY)
        .fontColor($r(Colors.TEXT_TERTIARY))
      Blank()
    }
    .width('100%')
    .margin({ bottom: Spacing.ELEMENT_SPACING_SM })
  }

  @Builder
  QuestionBankTab() {
    Column() {
      Row() {
        this.FilterChips()
      }
      .width('100%')
      .margin({ bottom: Spacing.ELEMENT_SPACING_SM })

      this.StatsRow()

      if (this.getFilteredQuestions().length === 0) {
        Column() {
          Image($r('app.media.icon_search'))
            .width(Sizes.ICON_XL)
            .height(Sizes.ICON_XL)
            .margin({ bottom: Spacing.ELEMENT_SPACING_MD })
          Text('æœªæ‰¾åˆ°ç›¸å…³é¢è¯•é¢˜')
            .fontSize(FontSizes.BODY)
            .fontColor($r(Colors.TEXT_TERTIARY))
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        Scroll() {
          GridRow({
            columns: 12,
            gutter: { x: Spacing.ELEMENT_SPACING_MD, y: Spacing.LIST_ITEM_MARGIN }
          }) {
            ForEach(this.getFilteredQuestions(), (item: InterviewItem) => {
              GridCol({ span: { sm: 12, md: 6 } }) {
                this.InterviewItemCard(item)
              }
            }, (item: InterviewItem) => item.id)
          }
          .width('100%')
        }
        .width('100%')
        .layoutWeight(1)
      }
    }
    .width('100%')
    .layoutWeight(1)
  }

  // ========== æ¨¡æ‹Ÿé¢è¯•æ ‡ç­¾é¡µ ==========
  @Builder
  MockSetupScreen() {
    Column() {
      // æ ‡é¢˜åŒºåŸŸ
      Column() {
        Text('æ¨¡æ‹Ÿé¢è¯•')
          .fontSize(FontSizes.TITLE)
          .fontWeight(FontWeights.BOLD)
          .fontColor($r(Colors.TEXT_PRIMARY))
          .margin({ bottom: 8 })

        Text('åœ¨å‹åŠ›ä¸‹é”»ç‚¼è¡¨è¾¾èƒ½åŠ›')
          .fontSize(FontSizes.SMALL)
          .fontColor($r(Colors.TEXT_TERTIARY))
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
      .margin({ bottom: 40 })

      // è®¡æ—¶å™¨é€‰æ‹©å¡ç‰‡
      Column() {
        Text('é€‰æ‹©æ—¶é—´é™åˆ¶')
          .fontSize(FontSizes.BODY)
          .fontWeight(FontWeights.MEDIUM)
          .fontColor($r(Colors.TEXT_PRIMARY))
          .width('100%')
          .margin({ bottom: 16 })

        Row() {
          ForEach(this.timerPresets, (preset: TimerPreset, index: number) => {
            Text(preset.label)
              .fontSize(FontSizes.BODY)
              .fontWeight(FontWeights.MEDIUM)
              .fontColor(this.selectedPresetIndex === index ? $r(Colors.TEXT_WHITE) : $r(Colors.TEXT_SECONDARY))
              .layoutWeight(1)
              .height(Sizes.SEARCH_BAR_HEIGHT)
              .textAlign(TextAlign.Center)
              .backgroundColor(this.selectedPresetIndex === index ? $r(Colors.RUST_PRIMARY) : $r(Colors.BG_SECONDARY))
              .borderRadius(Sizes.RADIUS_LG)
              .margin({ right: index < 3 ? 12 : 0 })
              .onClick(() => {
                this.selectedPresetIndex = index;
              })
          }, (preset: TimerPreset, index: number) => `preset-${index}`)
        }
        .width('100%')
      }
      .width('100%')
      .padding(Spacing.CARD_PADDING)
      .backgroundColor($r(Colors.BG_CARD))
      .borderRadius(Sizes.RADIUS_XL)
      .margin({ bottom: 24 })

      // æç¤ºå¡ç‰‡
      Column() {
        Text('æç¤º')
          .fontSize(FontSizes.SMALL)
          .fontWeight(FontWeights.BOLD)
          .fontColor($r(Colors.RUST_PRIMARY))
          .width('100%')
          .margin({ bottom: 12 })

        Text('â€¢ å¤§å£°è¯´å‡ºä½ çš„ç­”æ¡ˆ')
          .fontSize(FontSizes.SMALL)
          .fontColor($r(Colors.TEXT_SECONDARY))
          .width('100%')
          .margin({ bottom: 8 })

        Text('â€¢ è®¡æ—¶ç»“æŸåè¿›è¡Œè‡ªæˆ‘è¯„ä»·')
          .fontSize(FontSizes.SMALL)
          .fontColor($r(Colors.TEXT_SECONDARY))
          .width('100%')
      }
      .width('100%')
      .padding(Spacing.CARD_PADDING)
      .backgroundColor($r(Colors.BG_CARD))
      .borderRadius(Sizes.RADIUS_XL)
      .alignItems(HorizontalAlign.Start)
      .margin({ bottom: 40 })

      Blank()

      // å¼€å§‹æŒ‰é’®
      Text('å¼€å§‹æ¨¡æ‹Ÿ')
        .fontSize(FontSizes.BODY)
        .fontWeight(FontWeights.BOLD)
        .fontColor($r(Colors.TEXT_WHITE))
        .width('100%')
        .height(Sizes.BUTTON_HEIGHT_XL)
        .textAlign(TextAlign.Center)
        .backgroundColor($r(Colors.RUST_PRIMARY))
        .borderRadius(Sizes.RADIUS_XL)
        .margin({ bottom: 20 })
        .onClick(() => {
          this.startMockInterview();
        })
    }
    .width('100%')
    .layoutWeight(1)
    .padding({ top: 20 })
  }

  @Builder
  MockRunningScreen() {
    Column() {
      // é—®é¢˜å¡ç‰‡
      Column() {
        if (this.getCurrentMockQuestion()) {
          Column() {
            Row() {
              this.DifficultyBadge(this.getCurrentMockQuestion()!.difficulty)
            }

            Text(this.getCurrentMockQuestion()!.question)
              .fontSize(FontSizes.LARGE)
              .fontWeight(FontWeights.MEDIUM)
              .fontColor($r(Colors.TEXT_PRIMARY))
              .lineHeight(28)
              .textAlign(TextAlign.Center)
              .margin({ top: 16 })
          }
          .width('100%')
          .alignItems(HorizontalAlign.Center)
        }
      }
      .width('100%')
      .padding(Spacing.CARD_PADDING_LARGE)
      .backgroundColor($r(Colors.BG_CARD))
      .borderRadius(Sizes.RADIUS_XL)
      .margin({ bottom: 40 })

      // è®¡æ—¶å™¨
      Text(this.formatTime(this.remainingSeconds))
        .fontSize(FontSizes.GAME_TIMER)
        .fontWeight(FontWeights.BOLD)
        .fontColor(this.getTimerColor())
        .margin({ bottom: 40 })

      Blank()

      // åº•éƒ¨æŒ‰é’®
      Row() {
        Text('è·³è¿‡')
          .fontSize(FontSizes.BODY)
          .fontWeight(FontWeights.MEDIUM)
          .fontColor($r(Colors.TEXT_SECONDARY))
          .layoutWeight(1)
          .height(Sizes.BUTTON_HEIGHT_LG)
          .textAlign(TextAlign.Center)
          .backgroundColor($r(Colors.BG_SECONDARY))
          .borderRadius(Sizes.RADIUS_LG)
          .onClick(() => {
            this.skipQuestion();
          })

        Text('ç»“æŸ')
          .fontSize(FontSizes.BODY)
          .fontWeight(FontWeights.MEDIUM)
          .fontColor($r(Colors.ERROR))
          .layoutWeight(1)
          .height(Sizes.BUTTON_HEIGHT_LG)
          .textAlign(TextAlign.Center)
          .backgroundColor($r(Colors.ERROR_BG))
          .borderRadius(Sizes.RADIUS_LG)
          .margin({ left: 12 })
          .onClick(() => {
            this.stopTimer();
            this.mockState = MockState.TIMEOUT;
          })
      }
      .width('100%')
      .margin({ bottom: 20 })
    }
    .width('100%')
    .layoutWeight(1)
    .padding({ top: 20 })
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  MockTimeoutScreen() {
    Column() {
      // é—®é¢˜å¡ç‰‡
      Column() {
        if (this.getCurrentMockQuestion()) {
          Column() {
            Row() {
              this.DifficultyBadge(this.getCurrentMockQuestion()!.difficulty)
            }

            Text(this.getCurrentMockQuestion()!.question)
              .fontSize(FontSizes.LARGE)
              .fontWeight(FontWeights.MEDIUM)
              .fontColor($r(Colors.TEXT_PRIMARY))
              .lineHeight(28)
              .textAlign(TextAlign.Center)
              .margin({ top: 16 })
          }
          .width('100%')
          .alignItems(HorizontalAlign.Center)
        }
      }
      .width('100%')
      .padding(Spacing.CARD_PADDING_LARGE)
      .backgroundColor($r(Colors.BG_CARD))
      .borderRadius(Sizes.RADIUS_XL)
      .margin({ bottom: 40 })

      // æ—¶é—´åˆ°æç¤º
      Column() {
        Text("æ—¶é—´åˆ°")
          .fontSize(FontSizes.GAME_RESULT_TITLE)
          .fontWeight(FontWeights.BOLD)
          .fontColor($r(Colors.ERROR))
          .margin({ bottom: 12 })

        Text('ä½ å›ç­”å¾—æ€ä¹ˆæ ·ï¼Ÿ')
          .fontSize(FontSizes.BODY)
          .fontColor($r(Colors.TEXT_SECONDARY))
      }
      .width('100%')
      .alignItems(HorizontalAlign.Center)
      .margin({ bottom: 32 })

      // è‡ªæˆ‘è¯„ä»·æŒ‰é’®å¡ç‰‡
      Column() {
        Row() {
          Text('ğŸ˜Š è‡ªä¿¡')
            .fontSize(FontSizes.BODY)
            .fontWeight(FontWeights.MEDIUM)
            .fontColor($r(Colors.SUCCESS))
            .layoutWeight(1)
            .height(Sizes.BUTTON_HEIGHT_XL)
            .textAlign(TextAlign.Center)
            .backgroundColor($r(Colors.SUCCESS_BG))
            .borderRadius(Sizes.RADIUS_LG)
            .onClick(() => {
              this.submitRating(0);
            })

          Text('ğŸ˜ ä¸€èˆ¬')
            .fontSize(FontSizes.BODY)
            .fontWeight(FontWeights.MEDIUM)
            .fontColor($r(Colors.WARNING))
            .layoutWeight(1)
            .height(Sizes.BUTTON_HEIGHT_XL)
            .textAlign(TextAlign.Center)
            .backgroundColor($r(Colors.WARNING_BG))
            .borderRadius(Sizes.RADIUS_LG)
            .margin({ left: 12 })
            .onClick(() => {
              this.submitRating(1);
            })

          Text('ğŸ˜° æ…Œäº†')
            .fontSize(FontSizes.BODY)
            .fontWeight(FontWeights.MEDIUM)
            .fontColor($r(Colors.ERROR))
            .layoutWeight(1)
            .height(Sizes.BUTTON_HEIGHT_XL)
            .textAlign(TextAlign.Center)
            .backgroundColor($r(Colors.ERROR_BG))
            .borderRadius(Sizes.RADIUS_LG)
            .margin({ left: 12 })
            .onClick(() => {
              this.submitRating(2);
            })
        }
        .width('100%')
      }
      .width('100%')
      .padding(Spacing.CARD_PADDING)
      .backgroundColor($r(Colors.BG_CARD))
      .borderRadius(Sizes.RADIUS_XL)
      .margin({ bottom: 40 })

      Blank()

      // è¿”å›æŒ‰é’®
      Text('è¿”å›è®¾ç½®')
        .fontSize(FontSizes.SMALL)
        .fontColor($r(Colors.TEXT_TERTIARY))
        .margin({ bottom: 20 })
        .onClick(() => {
          this.exitMock();
        })
    }
    .width('100%')
    .layoutWeight(1)
    .padding({ top: 20 })
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  MockReviewScreen() {
    Column() {
      // å¯æ»šåŠ¨å†…å®¹åŒºåŸŸ
      Scroll() {
        Column() {
          // è¯„ä»·ç»“æœ
          Column() {
            Text(this.selfRating === 0 ? 'è¡¨ç°è‡ªä¿¡ï¼' : this.selfRating === 1 ? 'è¿˜å¯ä»¥' : 'éœ€è¦åŠ å¼º')
              .fontSize(FontSizes.LARGE)
              .fontWeight(FontWeights.BOLD)
              .fontColor(this.selfRating === 0 ? $r(Colors.SUCCESS) : this.selfRating === 1 ? $r(Colors.WARNING) : $r(Colors.ERROR))
          }
          .width('100%')
          .alignItems(HorizontalAlign.Center)
          .margin({ bottom: 40 })

          // é—®é¢˜å›é¡¾å¡ç‰‡
          Column() {
            Text('åˆšæ‰çš„é—®é¢˜')
              .fontSize(FontSizes.SMALL)
              .fontWeight(FontWeights.BOLD)
              .fontColor($r(Colors.TEXT_TERTIARY))
              .width('100%')
              .margin({ bottom: 12 })

            if (this.getCurrentMockQuestion()) {
              Text(this.getCurrentMockQuestion()!.question)
                .fontSize(FontSizes.BODY)
                .fontWeight(FontWeights.MEDIUM)
                .fontColor($r(Colors.TEXT_PRIMARY))
                .lineHeight(24)
                .width('100%')
                .margin({ bottom: 20 })

              Divider()
                .color($r(Colors.BG_SECONDARY))
                .margin({ bottom: 20 })

              Text('å‚è€ƒè¦ç‚¹')
                .fontSize(FontSizes.SMALL)
                .fontWeight(FontWeights.BOLD)
                .fontColor($r(Colors.RUST_PRIMARY))
                .width('100%')
                .margin({ bottom: 12 })

              Text(this.getCurrentMockQuestion()!.answer)
                .fontSize(FontSizes.SMALL)
                .fontColor($r(Colors.TEXT_SECONDARY))
                .lineHeight(22)
                .width('100%')
            }
          }
          .width('100%')
          .padding(Spacing.CARD_PADDING)
          .backgroundColor($r(Colors.BG_CARD))
          .borderRadius(Sizes.RADIUS_XL)
          .alignItems(HorizontalAlign.Start)
          .margin({ bottom: 20 })
        }
        .width('100%')
        .padding({ top: 20 })
      }
      .width('100%')
      .layoutWeight(1)
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)

      // åº•éƒ¨æŒ‰é’®ï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼‰
      Row() {
        Text('ç»“æŸ')
          .fontSize(FontSizes.BODY)
          .fontWeight(FontWeights.MEDIUM)
          .fontColor($r(Colors.TEXT_SECONDARY))
          .layoutWeight(1)
          .height(Sizes.BUTTON_HEIGHT_LG)
          .textAlign(TextAlign.Center)
          .backgroundColor($r(Colors.BG_SECONDARY))
          .borderRadius(Sizes.RADIUS_LG)
          .onClick(() => {
            this.exitMock();
          })

        Text('ä¸‹ä¸€é¢˜')
          .fontSize(FontSizes.BODY)
          .fontWeight(FontWeights.MEDIUM)
          .fontColor($r(Colors.TEXT_WHITE))
          .layoutWeight(1)
          .height(Sizes.BUTTON_HEIGHT_LG)
          .textAlign(TextAlign.Center)
          .backgroundColor($r(Colors.RUST_PRIMARY))
          .borderRadius(Sizes.RADIUS_LG)
          .margin({ left: 12 })
          .onClick(() => {
            this.nextQuestion();
          })
      }
      .width('100%')
      .margin({ bottom: 20 })
    }
    .width('100%')
    .layoutWeight(1)
  }

  @Builder
  MockInterviewTab() {
    Column() {
      Column() {
        if (this.mockState === MockState.SETUP) {
          this.MockSetupScreen()
        } else if (this.mockState === MockState.RUNNING) {
          this.MockRunningScreen()
        } else if (this.mockState === MockState.TIMEOUT) {
          this.MockTimeoutScreen()
        } else if (this.mockState === MockState.REVIEW) {
          this.MockReviewScreen()
        }
      }
      .width('100%')
      .layoutWeight(1)
      .constraintSize({ maxWidth: 800 })
    }
    .width('100%')
    .layoutWeight(1)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  AddQuestionDialog() {
    Column() {
      Text('æ·»åŠ é¢è¯•é—®é¢˜')
        .fontSize(FontSizes.LARGE)
        .fontWeight(FontWeights.BOLD)
        .fontColor($r(Colors.TEXT_PRIMARY))
        .width('100%')
        .margin({ bottom: Spacing.ELEMENT_SPACING_MD })

      Text('é—®é¢˜')
        .fontSize(FontSizes.SMALL)
        .fontColor($r(Colors.TEXT_SECONDARY))
        .width('100%')
        .margin({ bottom: Spacing.ELEMENT_SPACING_XS })
      TextInput({ text: this.newQuestionText, placeholder: 'è¯·è¾“å…¥é—®é¢˜å†…å®¹' })
        .width('100%')
        .height(50)
        .fontSize(FontSizes.BODY)
        .backgroundColor($r(Colors.BG_SECONDARY))
        .borderRadius(Sizes.RADIUS_LG)
        .padding({ left: 12, right: 12 })
        .margin({ bottom: Spacing.ELEMENT_SPACING_MD })
        .onChange((value: string) => {
          this.newQuestionText = value;
        })

      Text('ç­”æ¡ˆ/è¦ç‚¹')
        .fontSize(FontSizes.SMALL)
        .fontColor($r(Colors.TEXT_SECONDARY))
        .width('100%')
        .margin({ bottom: Spacing.ELEMENT_SPACING_XS })
      TextArea({ text: this.newAnswerText, placeholder: 'è¯·è¾“å…¥ç­”æ¡ˆæˆ–å‚è€ƒè¦ç‚¹' })
        .width('100%')
        .height(120)
        .fontSize(FontSizes.BODY)
        .backgroundColor($r(Colors.BG_SECONDARY))
        .borderRadius(Sizes.RADIUS_LG)
        .padding({ left: 12, right: 12, top: 12, bottom: 12 })
        .margin({ bottom: Spacing.ELEMENT_SPACING_MD })
        .onChange((value: string) => {
          this.newAnswerText = value;
        })

      Row() {
        Text('éš¾åº¦')
          .fontSize(FontSizes.SMALL)
          .fontColor($r(Colors.TEXT_SECONDARY))
          .margin({ right: Spacing.ELEMENT_SPACING_MD })
        ForEach(['ç®€å•', 'ä¸­ç­‰', 'å›°éš¾'], (difficulty: string) => {
          Text(difficulty)
            .fontSize(FontSizes.SMALL)
            .fontWeight(FontWeights.MEDIUM)
            .fontColor(this.newDifficulty === difficulty ? $r(Colors.TEXT_WHITE) : $r(Colors.TEXT_SECONDARY))
            .padding({ left: 12, right: 12, top: 6, bottom: 6 })
            .backgroundColor(this.newDifficulty === difficulty ? $r(Colors.RUST_PRIMARY) : $r(Colors.BG_SECONDARY))
            .borderRadius(Sizes.RADIUS_LG)
            .margin({ right: 8 })
            .onClick(() => {
              this.newDifficulty = difficulty;
            })
        }, (difficulty: string) => difficulty)
      }
      .width('100%')
      .margin({ bottom: Spacing.ELEMENT_SPACING_MD })

      Text('æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰')
        .fontSize(FontSizes.SMALL)
        .fontColor($r(Colors.TEXT_SECONDARY))
        .width('100%')
        .margin({ bottom: Spacing.ELEMENT_SPACING_XS })
      TextInput({ text: this.newTagsText, placeholder: 'ä¾‹å¦‚: æ‰€æœ‰æƒ, æ ¸å¿ƒæ¦‚å¿µ' })
        .width('100%')
        .height(50)
        .fontSize(FontSizes.BODY)
        .backgroundColor($r(Colors.BG_SECONDARY))
        .borderRadius(Sizes.RADIUS_LG)
        .padding({ left: 12, right: 12 })
        .margin({ bottom: Spacing.ELEMENT_SPACING_MD })
        .onChange((value: string) => {
          this.newTagsText = value;
        })

      Row() {
        Text('å–æ¶ˆ')
          .fontSize(FontSizes.BODY)
          .fontWeight(FontWeights.MEDIUM)
          .fontColor($r(Colors.TEXT_SECONDARY))
          .layoutWeight(1)
          .height(Sizes.BUTTON_HEIGHT_LG)
          .textAlign(TextAlign.Center)
          .backgroundColor($r(Colors.BG_SECONDARY))
          .borderRadius(Sizes.RADIUS_LG)
          .onClick(() => {
            if (this.onChangeShowAddDialog) {
              this.onChangeShowAddDialog(false);
            }
            this.resetAddForm();
          })

        Text('ç¡®å®š')
          .fontSize(FontSizes.BODY)
          .fontWeight(FontWeights.MEDIUM)
          .fontColor($r(Colors.TEXT_WHITE))
          .layoutWeight(1)
          .height(Sizes.BUTTON_HEIGHT_LG)
          .textAlign(TextAlign.Center)
          .backgroundColor($r(Colors.RUST_PRIMARY))
          .borderRadius(Sizes.RADIUS_LG)
          .margin({ left: 12 })
          .opacity(this.isSavingQuestion ? 0.7 : 1)
          .onClick(async () => {
            await this.handleAddQuestion();
          })
      }
      .width('100%')
    }
    .width('100%')
    .padding(Spacing.CARD_PADDING)
    .backgroundColor($r(Colors.BG_CARD))
    .borderRadius(Sizes.RADIUS_XL)
  }

  build() {
    Stack() {
      Column() {
        Column() {
          this.TabBar()

          if (this.activeTab === 0) {
            this.QuestionBankTab()
          } else {
            this.MockInterviewTab()
          }
        }
        .width('100%')
        .layoutWeight(1)
        .constraintSize({ maxWidth: 800 })
      }
      .width('100%')
      .height('100%')
      .alignItems(HorizontalAlign.Center)
      .padding({
        top: Spacing.PAGE_PADDING,
        left: Spacing.PAGE_PADDING,
        right: Spacing.PAGE_PADDING
      })
      .backgroundColor($r(Colors.BG_PAGE))

      if (this.showAddDialog) {
        Column() {
          Blank()
          Column() {
            this.AddQuestionDialog()
          }
          .width('90%')
          .constraintSize({ maxWidth: 400 })
          .margin({ left: Spacing.PAGE_PADDING, right: Spacing.PAGE_PADDING })
          .onClick(() => {
            // æ‹¦æˆªç‚¹å‡»äº‹ä»¶ï¼Œé¿å…ç‚¹å‡»å¯¹è¯æ¡†å†…å®¹æ—¶å…³é—­é®ç½©å±‚
          })
          Blank()
        }
        .width('100%')
        .height('100%')
        .backgroundColor('rgba(0, 0, 0, 0.5)')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .onClick(() => {
          if (this.onChangeShowAddDialog) {
            this.onChangeShowAddDialog(false);
          }
          this.resetAddForm();
        })
      }
    }
    .width('100%')
    .height('100%')
  }
}
