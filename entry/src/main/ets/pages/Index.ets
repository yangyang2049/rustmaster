import { Tab, Language } from '../data/RustTypes';
import { Spacing, Sizes, FontSizes, FontWeights, Shadows, Colors } from '../utils/DesignSystem';
import { NavBar } from '../components/NavBar';
import { LanguageSwitcher } from '../components/LanguageSwitcher';
import { LanguageManager } from '../utils/LanguageManager';
import { PreferencesManager } from '../utils/PreferencesManager';
import common from '@ohos.app.ability.common';
// Unified pages (supporting multiple languages)
import { LearnPage } from './learn/LearnPage';
import { SyntaxPage } from './syntax/SyntaxPage';
import { QuizPage } from './quiz/QuizPage';
import { InterviewPage } from './interview/InterviewPage';
import { SettingsPage } from './settings/SettingsPage';

@Entry
@Component
struct Index {
  @State @Watch('onCurrentTabChanged') currentTab: Tab = Tab.LEARN;
  @State showInterviewAddDialog: boolean = false; // æ§åˆ¶é¢è¯•é¡µé¢æ·»åŠ å¯¹è¯æ¡†
  @State learnPageRefreshTrigger: number = 0; // ç”¨äºè§¦å‘ LearnPage åˆ·æ–°
  @State currentLanguage: Language = Language.RUST; // å½“å‰é€‰æ‹©çš„ç¼–ç¨‹è¯­è¨€
  @State isLoadingLanguage: boolean = false; // è¯­è¨€åˆ‡æ¢æ—¶çš„loadingçŠ¶æ€
  @State pageKey: number = 0; // ç”¨äºå¼ºåˆ¶é‡æ–°æ„å»ºæ‰€æœ‰é¡µé¢
  @State showLanguageDialog: boolean = false; // æ˜¯å¦æ˜¾ç¤ºé¦–æ¬¡å¯åŠ¨è¯­è¨€é€‰æ‹©å¯¹è¯æ¡†
  @State dialogSelectedLanguage: Language = Language.RUST; // å¯¹è¯æ¡†ä¸­å½“å‰é€‰ä¸­çš„è¯­è¨€
  private context = getContext(this) as common.UIAbilityContext;

  async aboutToAppear() {
    // åŠ è½½å½“å‰é€‰æ‹©çš„è¯­è¨€
    this.currentLanguage = await LanguageManager.getCurrentLanguage(this.context);
    console.info(`[Index] aboutToAppear, loaded currentLanguage: ${this.currentLanguage}`);

    // æ£€æŸ¥æ˜¯å¦æ˜¯é¦–æ¬¡å¯åŠ¨ï¼ˆæ˜¯å¦æ˜¾ç¤ºè¿‡è¯­è¨€é€‰æ‹©å¯¹è¯æ¡†ï¼‰
    await this.checkFirstLaunch();
  }

  private async checkFirstLaunch(): Promise<void> {
    try {
      // ç¡®ä¿ PreferencesManager å·²åˆå§‹åŒ–
      PreferencesManager.init(this.context);
      const prefs = await PreferencesManager.getPreferences('app_settings');
      const hasShown = await prefs.get('has_shown_language_dialog', false) as boolean;
      
      if (!hasShown) {
        // é‡æ–°ä» LanguageManager è·å–å½“å‰è¯­è¨€ï¼Œç¡®ä¿è·å–æœ€æ–°å€¼
        const savedLanguage = await LanguageManager.getCurrentLanguage(this.context);
        console.info(`[Index] First launch, savedLanguage from LanguageManager: ${savedLanguage}`);
        
        // è®¾ç½®å¯¹è¯æ¡†é€‰ä¸­è¯­è¨€ä¸ºå½“å‰ä¿å­˜çš„è¯­è¨€
        this.dialogSelectedLanguage = savedLanguage;
        this.currentLanguage = savedLanguage;
        
        console.info(`[Index] Dialog will show with dialogSelectedLanguage: ${this.dialogSelectedLanguage}, currentLanguage: ${this.currentLanguage}`);
        
        // æ˜¾ç¤ºå¯¹è¯æ¡†
        this.showLanguageDialog = true;
      }
    } catch (err) {
      console.error(`[Index] Failed to check first launch: ${JSON.stringify(err)}`);
    }
  }

  private async onLanguageSelected(language: Language): Promise<void> {
    try {
      // æ›´æ–°å¯¹è¯æ¡†ä¸­çš„é€‰ä¸­çŠ¶æ€ï¼ˆç«‹å³åé¦ˆï¼‰
      this.dialogSelectedLanguage = language;
      
      // ä¿å­˜é€‰æ‹©çš„è¯­è¨€
      await LanguageManager.setCurrentLanguage(language, this.context);
      this.currentLanguage = language;
      
      // æ ‡è®°ä¸ºå·²æ˜¾ç¤ºå¯¹è¯æ¡†
      const prefs = await PreferencesManager.getPreferences('app_settings');
      await prefs.put('has_shown_language_dialog', true);
      await prefs.flush();
      
      // éšè—å¯¹è¯æ¡†
      this.showLanguageDialog = false;
      
      // å¼ºåˆ¶åˆ·æ–°é¡µé¢
      this.pageKey++;
      this.learnPageRefreshTrigger++;
      
      console.info(`[Index] Language selected: ${language}, dialog closed`);
    } catch (err) {
      console.error(`[Index] Failed to save language selection: ${JSON.stringify(err)}`);
    }
  }

  // å½“é¡µé¢æ˜¾ç¤ºæ—¶ï¼ˆä»å…¶ä»–é¡µé¢è¿”å›æ—¶ï¼‰ï¼Œè§¦å‘åˆ·æ–°
  async onPageShow() {
    // é‡æ–°åŠ è½½è¯­è¨€è®¾ç½®ï¼ˆå¯èƒ½è¢« LanguageSwitcher æ›´æ”¹ï¼‰
    this.currentLanguage = await LanguageManager.getCurrentLanguage(this.context);
    
    // å¦‚æœå½“å‰æ˜¯ LEARN æ ‡ç­¾é¡µï¼Œè§¦å‘åˆ·æ–°ä»¥æ›´æ–°ç« èŠ‚è¿›åº¦
    if (this.currentTab === Tab.LEARN) {
      this.learnPageRefreshTrigger++;
    }
  }

  private onCurrentTabChanged(): void {
    if (this.currentTab !== Tab.INTERVIEW && this.showInterviewAddDialog) {
      this.showInterviewAddDialog = false;
    }
    // å½“åˆ‡æ¢å› LEARN æ ‡ç­¾é¡µæ—¶ï¼Œè§¦å‘åˆ·æ–°
    if (this.currentTab === Tab.LEARN) {
      this.learnPageRefreshTrigger++;
    }
  }

  private getTitleText(): string {
    switch (this.currentTab) {
      case Tab.LEARN:
        return 'æ•™ç¨‹';
      case Tab.SYNTAX:
        return 'è¯­æ³•';
      case Tab.QUIZ:
        return 'æµ‹è¯•';
      case Tab.INTERVIEW:
        return 'é¢è¯•';
      case Tab.SETTINGS:
        return 'æˆ‘çš„';
      default:
        return 'ç ä¸Šå­¦';
    }
  }

  @Builder
  AddButtonBuilder() {
    Row() {
      Image($r('app.media.icon_add'))
        .width(24)
        .height(24)
    }
    .height('100%')
    .padding({ right: Spacing.PAGE_PADDING })
    .justifyContent(FlexAlign.Center)
    .onClick(() => {
      this.showInterviewAddDialog = true;
    })
  }

  @Builder
  LanguageSwitcherBuilder() {
    LanguageSwitcher({
      currentLanguage: this.currentLanguage, // ä¼ é€’å½“å‰è¯­è¨€ï¼Œç¡®ä¿åŒæ­¥
      onLanguageChanged: async (language: Language) => {
        console.info(`[Index] onLanguageChanged callback, new language: ${language}`);
        
        // æ˜¾ç¤ºå…¨å±loading
        this.isLoadingLanguage = true;
        
        // æ›´æ–°è¯­è¨€
        this.currentLanguage = language;
        
        // å¼ºåˆ¶é‡æ–°æ„å»ºæ‰€æœ‰é¡µé¢ - é€šè¿‡æ›´æ–°pageKey
        this.pageKey++;
        
        // è§¦å‘LearnPageåˆ·æ–°
        this.learnPageRefreshTrigger++;
        
        // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿æ•°æ®åŠ è½½å®Œæˆï¼Œç„¶åéšè—loading
        // ç»™è¶³å¤Ÿçš„æ—¶é—´è®©æ‰€æœ‰é¡µé¢é‡æ–°æ„å»ºå’ŒåŠ è½½æ•°æ®
        setTimeout(() => {
          this.isLoadingLanguage = false;
          console.info(`[Index] Language switch completed, pageKey: ${this.pageKey}`);
        }, 500);
      }
    })
      .key(`lang_switcher_${this.currentLanguage}`) // æ·»åŠ  keyï¼Œç¡®ä¿è¯­è¨€å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“
  }

  @Builder
  MenuBuilder() {
    Row() {
      // è¯­è¨€åˆ‡æ¢å™¨ - åªåœ¨ LEARN æ ‡ç­¾é¡µæ˜¾ç¤º
      if (this.currentTab === Tab.LEARN) {
        this.LanguageSwitcherBuilder()
      }

      // é¢è¯•é¡µé¢çš„æ·»åŠ æŒ‰é’®
      if (this.currentTab === Tab.INTERVIEW) {
        this.AddButtonBuilder()
      }
    }
    .height('100%')
  }

  @Builder
  PageContent() {
    // Unified pages that support multiple languages via props
    // ä½¿ç”¨pageKeyå¼ºåˆ¶é‡æ–°æ„å»ºï¼Œç¡®ä¿è¯­è¨€åˆ‡æ¢æ—¶æ‰€æœ‰é¡µé¢éƒ½é‡æ–°åŠ è½½æ•°æ®
    if (this.currentTab === Tab.LEARN) {
      LearnPage({
        language: this.currentLanguage,
        refreshTrigger: this.learnPageRefreshTrigger
      })
        .key(`learn_${this.pageKey}`)
    } else if (this.currentTab === Tab.SYNTAX) {
      SyntaxPage({ language: this.currentLanguage })
        .key(`syntax_${this.pageKey}`)
    } else if (this.currentTab === Tab.QUIZ) {
      QuizPage({ language: this.currentLanguage })
        .key(`quiz_${this.pageKey}`)
    } else if (this.currentTab === Tab.INTERVIEW) {
      InterviewPage({
        language: this.currentLanguage,
        showAddDialog: this.showInterviewAddDialog,
        onChangeShowAddDialog: (show: boolean) => {
          this.showInterviewAddDialog = show;
        }
      })
        .key(`interview_${this.pageKey}`)
    } else if (this.currentTab === Tab.SETTINGS) {
      SettingsPage({ language: this.currentLanguage })
        .key(`settings_${this.pageKey}`)
    }
  }

  // ä½¿ç”¨æ˜¾å¼æ•°å€¼æ¯”è¾ƒï¼Œé¿å…æšä¸¾æ¯”è¾ƒé—®é¢˜
  private isLanguageSelected(lang: Language): boolean {
    return Number(this.dialogSelectedLanguage) === Number(lang);
  }

  @Builder
  LanguageSelectionDialog() {
    if (this.showLanguageDialog) {
      Stack({ alignContent: Alignment.Center }) {
        // åŠé€æ˜èƒŒæ™¯
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.6)')
          .onClick(() => {
            // ç¦æ­¢ç‚¹å‡»èƒŒæ™¯å…³é—­ï¼Œå¼ºåˆ¶é€‰æ‹©
          })
        
        // å¯¹è¯æ¡†å†…å®¹
        Column() {
          Text('æ¬¢è¿ğŸ‘')
            .fontSize(FontSizes.TITLE)
            .fontWeight(FontWeights.BOLD)
            .fontColor($r(Colors.TEXT_PRIMARY))
            .margin({ bottom: Spacing.ELEMENT_SPACING_XS })
          
          Text('è¯·é€‰æ‹©æ‚¨æƒ³å­¦ä¹ çš„è¯­è¨€')
            .fontSize(FontSizes.BODY)
            .fontColor($r(Colors.TEXT_SECONDARY))
            .margin({ bottom: Spacing.ELEMENT_SPACING_LG })
          
          GridRow({
            columns: 2,
            gutter: { x: Spacing.ELEMENT_SPACING_MD, y: Spacing.ELEMENT_SPACING_MD }
          }) {
            ForEach(LanguageManager.getSupportedLanguages(), (lang: Language) => {
              GridCol() {
                Button() {
                  Column() {
                    Text(LanguageManager.getLanguageDisplayName(lang))
                      .fontSize(FontSizes.LARGE)
                      .fontWeight(FontWeights.BOLD)
                      .fontColor(this.isLanguageSelected(lang) ? $r(Colors.TEXT_WHITE) : $r(Colors.TEXT_PRIMARY))
                  }
                  .width('100%')
                  .padding({ top: 20, bottom: 20 })
                }
                .width('100%')
                .type(ButtonType.Normal)
                .backgroundColor(this.isLanguageSelected(lang) ? $r(Colors.RUST_PRIMARY) : $r(Colors.BG_SECONDARY))
                .borderRadius(Sizes.RADIUS_LG)
                .onClick(() => {
                  this.onLanguageSelected(lang);
                })
              }
            })
          }
          .width('100%')
        }
        .width('85%')
        .constraintSize({ maxWidth: 400 })
        .padding(Spacing.CARD_PADDING_LARGE)
        .backgroundColor($r(Colors.BG_CARD))
        .borderRadius(Sizes.RADIUS_XL)
      }
      .width('100%')
      .height('100%')
      .zIndex(1000) // ç¡®ä¿åœ¨æœ€ä¸Šå±‚
    }
  }

  @Builder
  LoadingOverlay() {
    if (this.isLoadingLanguage) {
      Stack({ alignContent: Alignment.Center }) {
        // åŠé€æ˜èƒŒæ™¯
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('rgba(0, 0, 0, 0.3)')
        
        // LoadingæŒ‡ç¤ºå™¨
        Column() {
          LoadingProgress()
            .width(48)
            .height(48)
            .color($r(Colors.RUST_PRIMARY))
          
          Text('åˆ‡æ¢è¯­è¨€ä¸­...')
            .fontSize(FontSizes.BODY)
            .fontColor($r(Colors.TEXT_WHITE))
            .margin({ top: Spacing.ELEMENT_SPACING_MD })
        }
        .padding(Spacing.CARD_PADDING_LARGE)
        .backgroundColor($r(Colors.BG_CARD))
        .borderRadius(Sizes.RADIUS_XL)
      }
      .width('100%')
      .height('100%')
    }
  }

  build() {
    Navigation() {
      Column() {
        // ä¸»å†…å®¹åŒºåŸŸ
        Stack() {
          this.PageContent()
          
          // å…¨å±loadingè¦†ç›–å±‚
          this.LoadingOverlay()

          // é¦–æ¬¡å¯åŠ¨è¯­è¨€é€‰æ‹©å¯¹è¯æ¡†
          this.LanguageSelectionDialog()
        }
        .width('100%')
        .layoutWeight(1)

        // åº•éƒ¨å¯¼èˆªæ 
        NavBar({ currentTab: this.currentTab })
      }
      .width('100%')
      .height('100%')
      .backgroundColor($r(Colors.BG_PAGE))
    }
    .titleMode(NavigationTitleMode.Mini)
    .mode(NavigationMode.Stack)
    .title(this.getTitleText())
    .menus(this.MenuBuilder)
    .hideBackButton(true)
    .backgroundColor($r(Colors.BG_CARD))
    .onTitleModeChange((titleMode: NavigationTitleMode) => {
      // å½“ Navigation æ ‡é¢˜æ¨¡å¼å˜åŒ–æ—¶ï¼ˆé€šå¸¸è¡¨ç¤ºé¡µé¢è¿”å›ï¼‰ï¼Œå¦‚æœå½“å‰æ˜¯ LEARN æ ‡ç­¾é¡µï¼Œè§¦å‘åˆ·æ–°
      if (this.currentTab === Tab.LEARN) {
        this.learnPageRefreshTrigger++;
      }
    })
  }
}
